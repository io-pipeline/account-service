# ======================================================================================================================
# Application
# ======================================================================================================================
quarkus.application.name=account-service
quarkus.application.version=1.0.0

# Container Image Configuration
quarkus.container-image.registry=git.rokkon.com
quarkus.container-image.group=io-pipeline
quarkus.container-image.name=account-service
quarkus.container-image.tag=latest
quarkus.container-image.additional-tags=${quarkus.application.version}

# ======================================================================================================================
# HTTP / gRPC Configuration
# ======================================================================================================================
# Default HTTP/gRPC configuration
quarkus.http.host=0.0.0.0
quarkus.http.port=38105

quarkus.grpc.server.use-separate-server=false
quarkus.grpc.server.enable-reflection-service=true
quarkus.grpc.server.max-inbound-message-size=2147483647

# Set gRPC message size limits for all clients (wildcard)
quarkus.grpc.clients."*".max-inbound-message-size=2147483647

# Dev configuration
%dev.quarkus.http.port=38105
%dev.quarkus.http.host=0.0.0.0
%dev.quarkus.http.root-path=/account

# Test configuration
%test.quarkus.http.test-port=0
%test.quarkus.grpc.server.use-separate-server=false

# ======================================================================================================================
# Database Configuration
# ======================================================================================================================
# Datasource configuration
quarkus.datasource.db-kind=mysql
quarkus.datasource.username=pipeline
quarkus.datasource.password=password

# Dev mode - use MySQL dev service (port 3306) - separate database for account-manager
%dev.quarkus.datasource.jdbc.url=jdbc:mysql://localhost:3306/pipeline_account_dev

# Hibernate configuration - use current property names
# Dev: Use Flyway migrations to manage schema
%dev.quarkus.hibernate-orm.schema-management.strategy=none
%dev.quarkus.flyway.migrate-at-start=true
%dev.quarkus.flyway.baseline-on-migrate=true

# Test: Clean database and let Hibernate create schema with initial data
%test.quarkus.hibernate-orm.schema-management.strategy=drop-and-create
%test.quarkus.hibernate-orm.sql-load-script=import.sql
%test.quarkus.flyway.migrate-at-start=false
%test.quarkus.flyway.clean-at-start=true

# Prod: Use migrations
%prod.quarkus.hibernate-orm.schema-management.strategy=validate
%prod.quarkus.flyway.migrate-at-start=true

# Common settings
quarkus.hibernate-orm.sql-load-script=no-file

# ======================================================================================================================
# Dev Services Configuration
# ======================================================================================================================
# General Dev Services
%dev.quarkus.devservices.enabled=true

# Docker Compose Dev Services (Dev Profile) - Use shared dev services
%dev.quarkus.compose.devservices.files=src/test/resources/compose-devservices.yml
%dev.quarkus.devservices.timeout=120s
%dev.quarkus.compose.devservices.start-services=true
%dev.quarkus.compose.devservices.stop-services=false
%dev.quarkus.compose.devservices.reuse-project-for-tests=true
%dev.quarkus.compose.devservices.stop-timeout=30s
%dev.quarkus.compose.devservices.project-name=pipeline-shared-devservices

# Test profile - use compose devservices with container hostnames (works in DinD!)
%test.quarkus.devservices.enabled=true
%test.quarkus.compose.devservices.files=src/test/resources/compose-test-services.yml
%test.quarkus.compose.devservices.start-services=true
%test.quarkus.compose.devservices.project-name=pipeline-test-services
%test.quarkus.compose.devservices.stop-services=false
%test.quarkus.compose.devservices.reuse-project-for-tests=true
%test.quarkus.compose.devservices.stop-timeout=30s

# Disable individual devservices (compose provides everything)
%test.quarkus.datasource.devservices.enabled=false
%test.quarkus.kafka.devservices.enabled=false

# Test datasource and Kafka config
# Local: uses localhost with mapped ports
# DinD: override with container hostnames via environment variables
%test.quarkus.datasource.jdbc.url=jdbc:mysql://${TEST_MYSQL_HOST:localhost}:${TEST_MYSQL_PORT:3307}/pipeline_account_test
%test.quarkus.datasource.username=pipeline
%test.quarkus.datasource.password=password
%test.kafka.bootstrap.servers=${TEST_KAFKA_HOST:localhost}:${TEST_KAFKA_PORT:9095}
%test.mp.messaging.connector.smallrye-kafka.bootstrap.servers=${TEST_KAFKA_HOST:localhost}:${TEST_KAFKA_PORT:9095}
%test.mp.messaging.connector.smallrye-kafka.apicurio.registry.url=http://${TEST_APICURIO_HOST:localhost}:${TEST_APICURIO_PORT:8082}/apis/registry/v3
%test.mp.messaging.outgoing.account-events.apicurio.registry.url=http://${TEST_APICURIO_HOST:localhost}:${TEST_APICURIO_PORT:8082}/apis/registry/v3

# WireMock will be configured per test using WireMockGrpcTestResource

# ======================================================================================================================
# Service Registration Configuration
# ======================================================================================================================
service.registration.enabled=true
service.registration.service-name=account-manager
service.registration.description=Account management service for multi-tenant support
service.registration.service-type=APPLICATION
service.registration.host=${ACCOUNT_MANAGER_HOST:host.docker.internal}
service.registration.port=${quarkus.http.port}
service.registration.capabilities=account-management,multi-tenant
service.registration.tags=account,management,core-service,traefik.enable=true,traefik.http.routers.account-manager.rule=PathPrefix(`/account`),traefik.http.routers.account-manager.entrypoints=web,traefik.http.middlewares.account-slash.redirectregex.regex=^/account$$,traefik.http.middlewares.account-slash.redirectregex.replacement=/account/,traefik.http.routers.account-manager.middlewares=account-slash
%test.service.registration.enabled=false

# Use service discovery for registration service
pipeline.registration.discovery-name=account-manager

# ======================================================================================================================
# Account Service Configuration
# ======================================================================================================================
# Dev-only S3 bucket creation (disabled in production)
account.dev.s3-bucket-creation=false
%dev.account.dev.s3-bucket-creation=true
%test.account.dev.s3-bucket-creation=false
%prod.account.dev.s3-bucket-creation=false

# Repository service gRPC client configuration
quarkus.grpc.clients.repository-service.host=localhost
quarkus.grpc.clients.repository-service.port=38102

# ======================================================================================================================
# Apicurio Registry Configuration
# ======================================================================================================================
quarkus.index-dependency.apicurio-registry.group-id=io.apicurio
quarkus.index-dependency.apicurio-registry.artifact-id=apicurio-registry-protobuf-serde-kafka

# ======================================================================================================================
# Kafka Channels
# ======================================================================================================================
# Account events channel
mp.messaging.outgoing.account-events.connector=smallrye-kafka
mp.messaging.outgoing.account-events.topic=account-events
mp.messaging.outgoing.account-events.value.serializer=io.apicurio.registry.serde.protobuf.ProtobufKafkaSerializer
mp.messaging.outgoing.account-events.key.serializer=org.apache.kafka.common.serialization.StringSerializer
mp.messaging.outgoing.account-events.apicurio.registry.auto-register=true
mp.messaging.outgoing.account-events.apicurio.registry.artifact-id=account-events-value
mp.messaging.outgoing.account-events.apicurio.registry.artifact-type=PROTOBUF
mp.messaging.outgoing.account-events.apicurio.registry.proto.message-name=AccountEvent
# Use the kafka.bootstrap.servers property which is injected by compose devservices in test mode
mp.messaging.outgoing.account-events.bootstrap.servers=${kafka.bootstrap.servers:localhost:9094}
%dev.mp.messaging.outgoing.account-events.apicurio.registry.url=http://localhost:8081/apis/registry/v3
%prod.mp.messaging.outgoing.account-events.apicurio.registry.url=http://apicurio-registry:8080/apis/registry/v3

# ======================================================================================================================
# Kafka Configuration
# ======================================================================================================================
kafka.bootstrap.servers=${KAFKA_BOOTSTRAP_SERVERS:localhost:9094}
%dev.kafka.bootstrap.servers=localhost:9094
%prod.kafka.bootstrap.servers=kafka:9092

# Kafka Dev Services
%dev.quarkus.kafka.devservices.enabled=true

# Apicurio Registry configuration (global default)
mp.messaging.connector.smallrye-kafka.apicurio.registry.url=${APICURIO_REGISTRY_URL:http://localhost:8081/apis/registry/v3}

# Kafka connector configuration (profile-specific overrides)
%dev.mp.messaging.connector.smallrye-kafka.bootstrap.servers=${kafka.bootstrap.servers}
%dev.mp.messaging.connector.smallrye-kafka.apicurio.registry.url=http://localhost:8081/apis/registry/v3
%prod.mp.messaging.connector.smallrye-kafka.bootstrap.servers=${kafka.bootstrap.servers}
%prod.mp.messaging.connector.smallrye-kafka.apicurio.registry.url=http://apicurio-registry:8080/apis/registry/v3
